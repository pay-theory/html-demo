<html>

    <head>
        <script src="TEMPLATE_URL"></script>
        <style>
            #main,
            form {
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
            }
			#main div {
				display: flex;
                flex-direction: row;
                justify-content: flex-start;
			}
        </style>
        <script type="text/javascript">
			const AMOUNT = 5000 + Math.floor(Math.random() * 5000)
            const first_name = 'Html'
            const last_name = 'Demo'
			const TRANSACTING_PARAMETERS = { 
					amount: AMOUNT,
					billingInfo: {
						first_name:`${first_name}`,
						last_name: `${last_name}`,
						address: {
							line1:"123 Sesame St",
							city:"New York City",
							region:"New York",
							postal_code:"12345",
							country:"US",
							account_code:"123_1234"
						}
					},
					metadata: {"account_no":"12345","ehr_id":"41DCD97F-8223-6FE6-2C52-6FE6A5ADD469","ehr_source":"cpp","email_address":"anon@gmail.com","facility_id":"1234","health_type":"LAF","mobile_phone":"(123) 456-7890","org_id":"123","origin":"family-portal-authenticated","resident_id":"1234567","resident_name":"ANON RESIDENT"}
			}	
		</script>		
    </head>

    <body>
        <div id="main">
            <div>
                <form>
                    <div id="pay-theory-credit-card-account-name"></div>
                    <div id="pay-theory-credit-card-number"></div>
                    <div id="pay-theory-credit-card-exp"></div>
                    <div id="pay-theory-credit-card-cvv"></div>
                    <div id="pay-theory-credit-card-zip"></div>
                    <div><input id="submit-payment" type="submit" disabled/></div>
                </form>
                <div>
                    <div id="amount"><input id="amount-in" type="text"></div>
                    <div id="first-name"><input id="first-name-in" type="text"></div>
                    <div id="last-name"><input id="last-name-in" type="text"></div>
                    <div id="billing-address-1"><input id="billing-address-1-in" type="text"></div>
                    <div id="billing-city"><input id="billing-city-in" type="text"></div>
					<div id="billing-state"><input id="billing-state-in" type="text"></div>
					<div id="billing-zip"><input id="billing-zip-in" type="text"></div>
				</div>				
            </div>
            <div id="result-text"></div>
            <div><em>you must replace YOUR-API-KEY in the URL to load the SDK</em></div>
        </div>
        </div>

		<script type="text/javascript">
			const prepElement = (element) => {
				document.getElementById(`${element}-in`).value = TRANSACTING_PARAMETERS[element]
				document.getElementById(`${element}-in`).onchange = (e) => {
					TRANSACTING_PARAMETERS[element] = e.target.value
				}
			}
			prepElement("amount")
			prepElement("first-name")
			prepElement("last-name")
			prepElement("billing-address-1")
			prepElement("billing-city")
			prepElement("billing-state")
			prepElement("billing-zip")
			let lineCount = 0
			const appendLine = (line,line_type) => {
				lineCount = lineCount + 1
				_div = document.createElement('div');
				_div.setAttribute('data-testid', 'result-line-' + line_type);
				_div.appendChild(document.createTextNode(line))
				return _div
			}
            // API KEY is required
            const urlParams = new URLSearchParams(window.location.search)
            const API_KEY = urlParams.get('api_key') ? urlParams.get('api_key') : 'NO_API_KEY_PROVIDED'



            // optionally define custom styles for the input components text
            const STYLES = {
                default: {
                    color: 'black',
                    fontSize: '14px'
                },
                success: {
                    color: '#5cb85c',
                    fontSize: '14px'
                },
                error: {
                    color: '#d9534f',
                    fontSize: '14px'
                }
            }
            window.paytheory.payTheoryFields({
                apiKey: API_KEY
            })

            const cleanupFunction = window.paytheory.validObserver(valid => {
                if (valid.includes("card")) {
                    document.getElementById('submit-payment').disabled = false
					document.getElementById('submit-payment').onclick = transact
                    // document.getElementById('result-text').textContent = "";
					let lineType = "ready"
                    document.getElementById('result-text').append(appendLine(lineType),lineType)
				} else {
					document.getElementById('submit-payment').disabled = true
                }
            }) 

            const errCleanupFunction =  window.paytheory.errorObserver(error => {
                // document.getElementById('result-text').textContent = "";
                document.getElementById('result-text').append(appendLine(`error: ${error}`,"error"))
            })            

            const transact = async (e) => {
                // document.getElementById('result-text').textContent = "";
                document.getElementById('result-text').append(appendLine("transact"),"transact")

                e.preventDefault()
                try {
                    let result = await window.paytheory.transact(TRANSACTING_PARAMETERS)
                
                    if (result.type === "SUCCESS") {
                        const statusContainer = document.getElementById("result-text");
                    
                        statusContainer.appendChild(
                            appendLine("success","success")
                        );
                    } else if (result.type === "FAILED") {
                        const statusContainer = document.getElementById("result-text");
                    
                        statusContainer.appendChild(
                            appendLine("failure","failure")
                        );
                    } else if (result.type === "ERROR") {
                        const statusContainer = document.getElementById("result-text");
                    
                        statusContainer.appendChild(
                            appendLine("error","error")
                        );
                    }
                } catch (error) {
                    const statusContainer = document.getElementById("result-text");
                    
                    statusContainer.appendChild(
						appendLine(error,"error")
                    );
                    console.log(error)
                }
                
            } 
        </script>
    </body>

</html>
